<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Quantum Fractal AI Cockpit</title>
<style>
  body { margin:0; background:#0f0f2a; overflow:hidden; font-family:sans-serif; display:flex; }
  #editor { width:50%; height:100vh; }
  #preview { width:50%; height:100vh; border-left:2px solid #222; overflow:auto; background:#fff; color:#000; padding:10px; }
  canvas { position:absolute; right:0; top:0; width:50%; height:100%; pointer-events:none; }
</style>
</head>
<body>

<div id="editor"></div>
<div id="preview"><h2>Live Preview</h2></div>
<canvas id="three-canvas"></canvas>

<!-- ACE Editor -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.14.0/ace.js"></script>

<!-- Three.js ES Module -->
<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js';

// ------------------ Three.js cockpit ------------------
const canvas = document.getElementById('three-canvas');
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(70, canvas.clientWidth/canvas.clientHeight, 0.1, 1000);
camera.position.z = 5;
const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
renderer.setSize(canvas.clientWidth, canvas.clientHeight);

const cube = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({color:0xff00ff}));
scene.add(cube);
const light = new THREE.PointLight(0xffffff,1);
light.position.set(5,5,5);
scene.add(light);

const models = ['cube','core','loop','wave','coin','code'];
const particles = {};
models.forEach(m=>{
  const mesh = new THREE.Mesh(new THREE.SphereGeometry(0.1,16,16), new THREE.MeshStandardMaterial({color:Math.random()*0xffffff}));
  mesh.position.set(Math.random()*4-2, Math.random()*4-2, Math.random()*4-2);
  mesh.progress = 0;
  scene.add(mesh);
  particles[m]=mesh;
});

function animate(){
  requestAnimationFrame(animate);
  cube.rotation.x += 0.003;
  cube.rotation.y += 0.004;
  for(const m of models){
    const p = particles[m];
    p.position.lerp(cube.position, p.progress||0.02);
  }
  renderer.render(scene,camera);
}
animate();

// ------------------ WebSocket Singleton + Retry ------------------
let ws = null;
let wsQueue = [];
let wsRetries = 0;
const maxRetries = 3;
const wsUrl = 'ws://localhost:3000';

function initWebSocket(){
  if(ws && (ws.readyState===WebSocket.OPEN || ws.readyState===WebSocket.CONNECTING)) return ws;
  ws = new WebSocket(wsUrl);

  ws.onopen = ()=>{
    console.log('[WS] connected');
    wsRetries=0;
    while(wsQueue.length>0) ws.send(JSON.stringify(wsQueue.shift()));
  };
  ws.onmessage = e=>{
    const msg = JSON.parse(e.data);
    if(msg.type==='modelProgress' && particles[msg.model]) particles[msg.model].progress=(msg.progress||0)/100;
    if(msg.type==='modelDone' && particles[msg.model]) particles[msg.model].progress=1;
    if(msg.type==='final') console.log('[FINAL RESULT]', msg.result);
  };
  ws.onclose = e=>{
    console.warn('[WS] closed');
    wsRetries++;
    if(wsRetries<=maxRetries){
      setTimeout(initWebSocket, 2000);
    } else {
      console.warn('[WS] Max retries reached. Using simulated mode.');
      simulateModels();
    }
  };
  ws.onerror = e=>{
    console.error('[WS] error', e);
    ws.close();
  };
  return ws;
}

// ------------------ HTML/JS Auto-Enhancer ------------------
function htmlEnhanceContent(content){
  if(!content) return content;
  if(!content.includes('--main-bg') && content.includes('<head>'))
    content = content.replace(/<head>/i,'<head><style>:root{--main-bg:#0f0f2a;--main-fg:#fff;--btn-color:#ff00ff;--link-color:#ffff00;}</style>');
  content = content.replace(/function\s+([a-zA-Z0-9_]+)\s*\(([^)]*)\)\s*\{/g,'function $1($2) { /* AI: optimize */');
  content = content.replace(/\.addEventListener\((['"])(.*?)\1,(.*)\)/g,'.addEventListener($1$2$1, /* AI: monitored */$3)');
  content = content.replace(/<div class="section"/gi,'<section class="section"');
  content = content.replace(/<\/div><!-- .section -->/gi,'</section>');
  content = content.replace(/<nav/gi,'<nav role="navigation"');
  content = content.replace(/<header/gi,'<header role="banner"');
  content = content.replace(/<main/gi,'<main role="main"');
  content = content.replace(/<footer/gi,'<footer role="contentinfo"');
  return content;
}

// ------------------ Send prompt safely ------------------
function sendPrompt(prompt){
  const enhanced = htmlEnhanceContent(prompt);
  if(!ws || ws.readyState!==WebSocket.OPEN){
    console.warn('[WS] not connected, simulating prompt');
    simulateModels();
  } else ws.send(JSON.stringify({type:'prompt',prompt:enhanced}));
}

// ------------------ Simulated Models ------------------
function simulateModels(){
  models.forEach((m,i)=>{
    const interval = setInterval(()=>{
      const p = particles[m];
      p.progress += 0.01;
      if(p.progress>=1){ p.progress=1; clearInterval(interval); }
    },100 + i*50);
  });
}

// ------------------ Live AJAX Preview ------------------
function updatePreview(content){
  const preview = document.getElementById('preview');
  preview.innerHTML = "<h2>Live Preview</h2><iframe style='width:100%;height:90%;border:none;' srcdoc='"+content.replace(/'/g,"&#39;")+"'></iframe>";
}

// ------------------ ACE Editor ------------------
const editor = ace.edit('editor');
editor.setTheme('ace/theme/monokai');
editor.session.setMode('ace/mode/html');
editor.session.setValue('<!DOCTYPE html>\n<html><head></head><body><h1>Hello Quantum AI</h1></body></html>');

// Real-time update preview on editor change
editor.session.on('change',()=>{
  updatePreview(editor.getValue());
});

// ------------------ Hotkey: Shift+Win+R ------------------
window.addEventListener('keydown',e=>{
  if(e.shiftKey && e.metaKey && e.code==='KeyR'){
    sendPrompt(editor.getValue());
  }
});

// ------------------ Init ------------------
initWebSocket();
setTimeout(()=>{ if(!ws || ws.readyState!==WebSocket.OPEN) simulateModels(); },2000);
updatePreview(editor.getValue());

</script>
</body>
</html>

